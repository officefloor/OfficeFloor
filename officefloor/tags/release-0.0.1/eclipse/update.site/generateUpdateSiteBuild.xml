<?xml version="1.0" encoding="UTF-8"?>
<project name="project" default="generate">

	<description>
	    Builds the Office Floor Eclipse Update Site Content.
    </description>

	<!-- ====== Ensure all properties available (and inherited from maven) ======== -->
	<target name="validate" description="Ensures all properties passed from maven for building">
		<fail unless="build.dir" message="Must provide property: build.dir" />
		<fail unless="dependency.dir" message="Must provide property: dependency.dir" />
		<fail unless="update.site.dir" message="Must provide property: update.site.dir" />
		<fail unless="version" message="Must provide property: version" />
	</target>
	<property name="extract.dir" value="${build.dir}/extract" />
	<property name="plugins.dir" value="${extract.dir}/plugins" />
	<property name="features.dir" value="${extract.dir}/features" />

	<!-- =========================== Tasks ==================================== -->

	<target name="prepare" depends="validate" description="Prepares the extract directory for clean update site content">
		<delete dir="${update.site.dir}" />
		<mkdir dir="${update.site.dir}" />
		<delete dir="${extract.dir}" />
		<mkdir dir="${extract.dir}" />
	</target>

	<target name="net.officefloor.core" depends="validate" description="Generates update site content for plugin net.officefloor.core">
		<property name="net.officefloor.core.dir" value="${plugins.dir}/net.officefloor.core_${version}" />
		<!-- Clean up class path for plugin -->
		<fileset dir="${net.officefloor.core.dir}" id="net.officefloor.core.jars">
			<include name="*.jar" />
		</fileset>
		<pathconvert pathsep="," property="net.officefloor.core.classpath" refid="net.officefloor.core.jars">
			<map from="${net.officefloor.core.dir}/" to="" />
		</pathconvert>
		<manifest mode="update" file="${net.officefloor.core.dir}/META-INF/MANIFEST.MF">
			<attribute name="Bundle-ClassPath" value=".,${net.officefloor.core.classpath}" />
		</manifest>
		<!-- Generate plugin for update site -->
		<jar basedir="${plugins.dir}/net.officefloor.core_${version}" manifest="${net.officefloor.core.dir}/META-INF/MANIFEST.MF" destfile="${update.site.dir}/net.officefloor.core_${version}.jar" />
	</target>

	<target name="net.officefloor.ui" depends="validate" description="Generates update site content for plugin net.officefloor.ui">
		<property name="net.officefloor.ui.dir" value="${plugins.dir}/net.officefloor.ui_${version}" />
		<!-- Clean up class path for plugin -->
		<manifest mode="update" file="${net.officefloor.ui.dir}/META-INF/MANIFEST.MF">
			<attribute name="Bundle-ClassPath" value="." />
		</manifest>
		<!-- Generate plugin for update site -->
		<jar basedir="${net.officefloor.ui.dir}" manifest="${net.officefloor.ui.dir}/META-INF/MANIFEST.MF" destfile="${update.site.dir}/net.officefloor.ui_${version}.jar" />
	</target>

	<target name="net.officefloor.feature" depends="validate" description="Generates update site content for feature net.officefloor.feature">
		<!-- Obtain the feature jar location -->
		<available property="feature.dependency.path" value="${dependency.dir}/net.officefloor.feature-${version}.zip" file="${dependency.dir}/net.officefloor.feature-${version}.zip" type="file" />
        <available property="feature.dependency.path" value="${dependency.dir}/net.officefloor.feature_${version}.bin.dist.zip" file="${dependency.dir}/net.officefloor.feature_${version}.bin.dist.zip" type="file" />
		<fail unless="feature.dependency.path" message="Can not find dependency: net.officefloor.feature (version ${version})" />
		<!-- Unzip the feature contents to extract directory -->
		<unzip src="${feature.dependency.path}" dest="${extract.dir}" />
		<!-- Generate plugin content -->
		<antcall target="net.officefloor.core" />
		<antcall target="net.officefloor.ui" />
		<!-- Generate feature content -->
		<jar basedir="${features.dir}/net.officefloor.feature_${version}" destfile="${update.site.dir}/net.officefloor.feature_${version}.jar" />
	</target>

	<target name="net.officefloor.filingcabinet" depends="validate" description="Generates update site content for the plugin net.officefloor.filingcabinet">
		<property name="net.officefloor.filingcabinet.dir" value="${plugins.dir}/net.officefloor.filingcabinet_${version}" />
		<!-- Unpack jar content and remove jars -->
		<unjar dest="${net.officefloor.filingcabinet.dir}">
			<fileset dir="${net.officefloor.filingcabinet.dir}" includes="*.jar" />
			<patternset excludes="META-INF/MANIFEST.MF" />
		</unjar>
		<delete>
			<fileset dir="${net.officefloor.filingcabinet.dir}" includes="*.jar" />
		</delete>
		<!-- Clean up class path for plugin -->
		<manifest mode="update" file="${net.officefloor.filingcabinet.dir}/META-INF/MANIFEST.MF">
			<attribute name="Bundle-ClassPath" value="." />
		</manifest>
		<!-- Generate plugin for update site -->
		<jar basedir="${net.officefloor.filingcabinet.dir}" manifest="${net.officefloor.filingcabinet.dir}/META-INF/MANIFEST.MF" destfile="${update.site.dir}/net.officefloor.filingcabinet_${version}.jar" />
	</target>

	<target name="net.officefloor.jdbc" depends="validate" description="Generates update site content for the plugin net.officefloor.jdbc">
		<property name="net.officefloor.jdbc.dir" value="${plugins.dir}/net.officefloor.jdbc_${version}" />
		<!-- Unpack jar content and remove jars -->
		<unjar dest="${net.officefloor.jdbc.dir}">
			<fileset dir="${net.officefloor.jdbc.dir}" includes="*.jar" />
			<patternset excludes="META-INF/MANIFEST.MF" />
		</unjar>
		<delete>
			<fileset dir="${net.officefloor.jdbc.dir}" includes="*.jar" />
		</delete>
		<!-- Clean up class path for plugin -->
		<manifest mode="update" file="${net.officefloor.jdbc.dir}/META-INF/MANIFEST.MF">
			<attribute name="Bundle-ClassPath" value="." />
		</manifest>
		<!-- Generate plugin for update site -->
		<jar basedir="${net.officefloor.jdbc.dir}" manifest="${net.officefloor.jdbc.dir}/META-INF/MANIFEST.MF" destfile="${update.site.dir}/net.officefloor.jdbc_${version}.jar" />
	</target>

	<target name="net.officefloor.socket" depends="validate" description="Generates update site content for the plugin net.officefloor.socket">
		<property name="net.officefloor.socket.dir" value="${plugins.dir}/net.officefloor.socket_${version}" />
		<!-- Unpack jar content and remove jars -->
		<unjar dest="${net.officefloor.socket.dir}">
			<fileset dir="${net.officefloor.socket.dir}" includes="*.jar" />
			<patternset excludes="META-INF/MANIFEST.MF" />
		</unjar>
		<delete>
			<fileset dir="${net.officefloor.socket.dir}" includes="*.jar" />
		</delete>
		<!-- Clean up class path for plugin -->
		<manifest mode="update" file="${net.officefloor.socket.dir}/META-INF/MANIFEST.MF">
			<attribute name="Bundle-ClassPath" value="." />
		</manifest>
		<!-- Generate plugin for update site -->
		<jar basedir="${net.officefloor.socket.dir}" manifest="${net.officefloor.socket.dir}/META-INF/MANIFEST.MF" destfile="${update.site.dir}/net.officefloor.socket_${version}.jar" />
	</target>

	<target name="net.officefloor.plugins.feature" depends="validate" description="Generates update site content for feature net.officefloor.plugins.feature">
        <!-- Obtain the feature plugins jar location -->
        <available property="plugins.feature.dependency.path" value="${dependency.dir}/net.officefloor.plugins.feature-${version}.zip" file="${dependency.dir}/net.officefloor.plugins.feature-${version}.zip" type="file" />
        <available property="plugins.feature.dependency.path" value="${dependency.dir}/net.officefloor.plugins.feature_${version}.bin.dist.zip" file="${dependency.dir}/net.officefloor.plugins.feature_${version}.bin.dist.zip" type="file" />
        <fail unless="plugins.feature.dependency.path" message="Can not find dependency: net.officefloor.feature (version ${version})" />
		<!-- Unzip the feature contents to extract directory -->
		<unzip src="${plugins.feature.dependency.path}" dest="${extract.dir}" />
		<!-- Generate plugin content -->
		<antcall target="net.officefloor.filingcabinet" />
		<antcall target="net.officefloor.jdbc" />
		<antcall target="net.officefloor.socket" />
		<!-- Generate feature content -->
		<jar basedir="${features.dir}/net.officefloor.plugins.feature_${version}" destfile="${update.site.dir}/net.officefloor.plugins.feature_${version}.jar" />
	</target>

	<target name="generate" depends="validate,prepare,net.officefloor.feature,net.officefloor.plugins.feature" description="Runs all tasks necessary to generate the update site content" />

</project>