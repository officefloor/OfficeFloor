<project name="Generate P2 Content">

	<target name="build-update-site-content"
		description="Addition functionality on maven to generate p2 content of Eclipse update site">

		<!-- Ensure parameters passed in from maven -->
		<fail message="Must specify property BUILD_DIR" unless="BUILD_DIR" />
		<fail message="Must provide P2 launcher jar location" unless="P2_LAUNCH_JAR" />
		<fail message="Must provide OfficeFloor version" unless="OFFICE_FLOOR_VERSION" />

		<!-- Copy in site and documentation files from OfficeFloor project -->
		<copy file="${basedir}/src/main/resources/site.xml" tofile="${BUILD_DIR}/site.xml" />
		<copy file="${basedir}/src/main/resources/index.html" tofile="${BUILD_DIR}/index.html" />

		<!-- Organise features -->
		<delete dir="${BUILD_DIR}/features" />
		<mkdir dir="${BUILD_DIR}/features" />
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="features" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.feature" />
		</antcall>
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="features" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.plugins.feature" />
		</antcall>

		<!-- Organise plug-ins -->
		<delete dir="${BUILD_DIR}/plugins" />
		<mkdir dir="${BUILD_DIR}/plugins" />
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="plugins" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.core" />
		</antcall>
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="plugins" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.ui" />
		</antcall>
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="plugins" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.jdbc" />
		</antcall>
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="plugins" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.socket" />
		</antcall>
		<antcall target="moveArtifact">
			<param name="SUB_DIR" value="plugins" />
			<param name="MOVE_ARTIFACT_ID" value="net.officefloor.filingcabinet" />
		</antcall>

		<!-- Only keep the necessary raw files -->
		<delete>
			<fileset dir="${BUILD_DIR}">
				<exclude name="features/**" />
				<exclude name="plugins/**" />
				<exclude name="site.xml" />
				<exclude name="index.html" />
			</fileset>
		</delete>

		<!-- Condition/Repack plug-in jars -->
		<antcall target="repackArtifact">
			<param name="CONDITION_ARTIFACT_ID" value="net.officefloor.core" />
		</antcall>
		<antcall target="repackArtifact">
			<param name="CONDITION_ARTIFACT_ID" value="net.officefloor.ui" />
		</antcall>
		<antcall target="repackArtifact">
			<param name="CONDITION_ARTIFACT_ID" value="net.officefloor.jdbc" />
		</antcall>
		<antcall target="repackArtifact">
			<param name="CONDITION_ARTIFACT_ID" value="net.officefloor.socket" />
		</antcall>
		<antcall target="repackArtifact">
			<param name="CONDITION_ARTIFACT_ID" value="net.officefloor.filingcabinet" />
		</antcall>

		<!-- Download existing releases for digest/content/artifacts jar -->
		<antcall target="downloadRelease">
			<param name="DOWNLOAD_RELEASE_VERSION" value="0.1.0" />
		</antcall>
		<antcall target="downloadRelease0.0.1" />

		<!-- Generate the digest and pack.jar.gz files -->
		<echo>Generating digest.zip and *.jar.pack.gz files</echo>
		<java jar="${P2_LAUNCH_JAR}" fork="true" failonerror="true">
			<arg line="-application org.eclipse.update.core.siteOptimizer" />
			<arg line="-digestBuilder" />
			<arg line="-digestOutputDir=${BUILD_DIR}" />
			<arg line="-siteXML=${BUILD_DIR}/site.xml" />
			<arg line="-jarProcessor" />
			<arg line="-verbose" />
			<arg line="-pack" />
			<arg line="-outputDir ${BUILD_DIR}" />
			<arg line="${BUILD_DIR}" />
		</java>

		<!-- Generate the content.jar and artifacts.jar files -->
		<echo>Generating content.jar and artifacts.jar files</echo>
		<java jar="${P2_LAUNCH_JAR}" fork="true" failonerror="true">
			<arg
				line="-application org.eclipse.equinox.p2.metadata.generator.EclipseGenerator" />
			<arg line="-updateSite ${BUILD_DIR}" />
			<arg line="-site file:${BUILD_DIR}/site.xml" />
			<arg line="-metadataRepository file:${BUILD_DIR}" />
			<arg line="-metadataRepositoryName &quot;$OfficeFloor Update Site&quot;" />
			<arg line="-artifactRepository file:${BUILD_DIR}" />
			<arg line="-artifactRepositoryName &quot;OfficeFloor Artifacts&quot;" />
			<arg line="-compress" />
			<arg line="-reusePack200Files" />
			<arg line="-noDefaultUIs" />
		</java>
	</target>

	<!-- Private task to organise and name the raw jars -->
	<target name="moveArtifact">
		<fail message="Must specify artifact to move" unless="MOVE_ARTIFACT_ID" />
		<fail message="Must specify sub-directory to move artifact"
			unless="SUB_DIR" />
		<move file="${BUILD_DIR}/${MOVE_ARTIFACT_ID}-${OFFICE_FLOOR_VERSION}.jar"
			tofile="${BUILD_DIR}/${SUB_DIR}/${MOVE_ARTIFACT_ID}_${OFFICE_FLOOR_VERSION}.jar" />
	</target>

	<!-- Private task to condition/repack an artifact -->
	<target name="repackArtifact">
		<fail message="Must specify artifact to condition" unless="CONDITION_ARTIFACT_ID" />
		<java jar="${P2_LAUNCH_JAR}" fork="true" failonerror="true">
			<arg line="-application org.eclipse.update.core.siteOptimizer" />
			<arg line="-jarProcessor" />
			<arg line="-verbose" />
			<arg line="-processAll" />
			<arg line="-repack" />
			<arg line="-outputDir ${BUILD_DIR}/plugins" />
			<arg
				line="${BUILD_DIR}/plugins/${CONDITION_ARTIFACT_ID}_${OFFICE_FLOOR_VERSION}.jar" />
		</java>
	</target>

	<!-- Private task to download a release artifacts for contents.jar -->
	<target name="downloadRelease">
		<fail message="Must specify the version of release to download"
			unless="DOWNLOAD_RELEASE_VERSION" />
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="plugins/net.officefloor.core_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="plugins/net.officefloor.ui_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="features/net.officefloor.feature_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="plugins/net.officefloor.jdbc_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="plugins/net.officefloor.socket_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="plugins/net.officefloor.filingcabinet_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT"
				value="features/net.officefloor.plugins.feature_${DOWNLOAD_RELEASE_VERSION}.jar" />
		</antcall>
	</target>

	<!-- Private task to download 0.0.1 release of different structure -->
	<target name="downloadRelease0.0.1">
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.core_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.ui_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.feature_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.filingcabinet_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.socket_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.jdbc_0.0.1.jar" />
		</antcall>
		<antcall target="downloadReleaseArtifact">
			<param name="DOWNLOAD_ARTIFACT" value="net.officefloor.plugins.feature_0.0.1.jar" />
		</antcall>
	</target>

	<!-- Private task to download an existing released artifact -->
	<target name="downloadReleaseArtifact">
		<fail message="Must specify artifact to download" unless="DOWNLOAD_ARTIFACT" />
		<echo>${DOWNLOAD_ARTIFACT}</echo>
		<get
			src="http://downloads.sourceforge.net/project/officefloor/eclipse/update/${DOWNLOAD_ARTIFACT}"
			dest="${BUILD_DIR}/${DOWNLOAD_ARTIFACT}" verbose="true" usetimestamp="true" />
	</target>

</project>